# MemoApp 機能仕様書

## 概要

MemoAppは、SwiftUI + UIKitのハイブリッド構成で開発されたiOS/iPadOS対応のマークダウンメモアプリケーションです。本文書は開発者向けの詳細な技術仕様書として、アーキテクチャ、実装詳細、データフロー等を記載しています。

## 1. アーキテクチャ概要

### 1.1 全体構成

```
MemoApp (SwiftUI App)
├── ContentView (Root Container)
└── MemoListView (Main UI)
    ├── MemoEditorView (Detail View)
    ├── HighlightableTextEditor (Custom Editor)
    └── Settings & Folder Management
```

### 1.2 データレイヤー

```
ObservableObject Stores
├── MemoStore (Memo CRUD Operations)
├── FolderStore (Folder Management)
└── Local JSON Persistence
    ├── Documents/memos.json
    ├── Documents/folders.json
    └── App Groups/widget_memos.json (Widget用)
```

### 1.3 技術スタック

- **UI Framework**: SwiftUI (iOS 15.0+) + UIKit (カスタムコンポーネント)
- **State Management**: ObservableObject + Combine
- **Data Persistence**: JSON + FileManager
- **Markdown Rendering**: AttributedString + NSAttributedString
- **Custom Editor**: UITextView (UIViewRepresentable)
- **Diagram Generation**: SVG + WebKit

## 2. データモデル詳細

### 2.1 Memo モデル

```swift
struct Memo: Identifiable, Codable {
    let id: UUID                    // Primary Key
    var title: String              // ユーザー入力タイトル
    var content: String            // マークダウン本文
    var createdAt: Date           // 作成日時 (ISO8601)
    var updatedAt: Date           // 更新日時 (ISO8601)
    var folderId: UUID?           // 外部キー -> Folder.id
    var isPinned: Bool            // ピン留めフラグ
}
```

**主要メソッド:**
- `displayTitle: String` - タイトル表示ロジック（マークダウン記号除去）
- `preview: String` - リスト表示用プレビューテキスト
- `updateContent(_:)` - 本文更新 + updatedAt自動更新
- `moveToFolder(_:)` - フォルダ移動 + updatedAt自動更新
- `togglePin()` - ピン留め切り替え + updatedAt自動更新

### 2.2 Folder モデル

```swift
struct Folder: Identifiable, Codable, Hashable {
    let id: UUID           // Primary Key
    var name: String       // フォルダ名 (ユニーク制約なし)
    let createdAt: Date    // 作成日時
    var updatedAt: Date    // 更新日時
}
```

**デフォルトフォルダ:**
- "個人", "仕事", "アイデア" (初回起動時自動作成)
- "すべてのメモ" (仮想フォルダ、実データなし)

## 主要機能

### メモ管理機能

#### 基本CRUD操作
- **作成**: 新規メモの作成
- **読取**: メモ一覧表示・個別表示
- **更新**: メモ内容の編集・保存
- **削除**: 個別削除・一括削除
- **自動削除**: 新規メモが空のまま終了した場合の自動削除（Apple純正風）

#### データ永続化
- **自動保存**: 編集内容の自動保存
- **JSON形式**: DocumentsディレクトリにJSON形式で保存
- **アプリ起動時復元**: 保存済みメモの自動読み込み

### Markdown機能

#### 対応記法
- **見出し**: H1-H6（#, ##, ###, ####, #####, ######）
- **強調**: **太字**、*斜体*
- **リスト**: 番号付き・箇条書きリスト
- **インデントリスト**: タブ文字、2個以上の半角スペースでインデント対応
  - スペース数に応じたレベル計算（2個=1レベル、4個=2レベル、6個=3レベル...）
  - タブと半角スペースの混在サポート
  - レベル別の番号管理
  - 任意の深さまでのネストサポート
- **コードブロック**: `インライン`、```ブロック```
- **引用**: > 引用文
- **リンク**: [テキスト](URL)
- **水平線**: ---

#### 表示機能
- **リアルタイムプレビュー**: 編集モードとプレビューモードの切り替え
- **シンタックスハイライト**: コードブロックの強調表示
- **カラーコーディング**: 要素タイプ別の色分け表示

### 図表・ダイアグラム機能

#### 対応図表タイプ
1. **フローチャート (Flowchart)**
   - Mermaid TD/LR記法対応
   - ノード形状: 矩形、菱形、楕円
   - 接続線: 実線、破線、矢印
   - 色合い: フローチャート風の淡い色パレット

2. **ガントチャート (Gantt)**
   - プロジェクト管理用タイムライン
   - セクション・タスク・期間設定
   - 依存関係表示

3. **円グラフ (Pie Chart)**
   - 数値データの視覚化
   - 自動パーセンテージ計算
   - カラーパレット自動適用

4. **クラス図 (Class Diagram)**
   - UML準拠クラス表現
   - 属性・メソッド表示
   - 継承・関連関係

5. **シーケンス図 (Sequence Diagram)**
   - 現在非対応 ("現在非対応です"表示)
   - 将来実装予定

#### SVG生成システム
- Mermaid記法の解析とSVG生成
- WebKit経由での表示
- 淡い色合いによる統一されたデザイン
- NSTextAttachmentとしてマークダウンに埋め込み

### 検索・置換機能

#### 検索機能
- **リアルタイム検索**: タイピング中の即座な検索結果表示
- **ハイライト機能**: 検索結果の視覚的強調
- **全文検索**: タイトル・本文両方の検索対応

#### 置換機能
- **検索と置換**: 個別置換・一括置換対応
- **ナビゲーション**: 前後の検索結果への移動
- **結果表示**: 検索結果件数の表示

### 編集支援機能

#### Markdownツールバー
- **見出し挿入**: H1-H4の自動挿入
- **フォーマット**: 太字・斜体・コードの自動挿入
- **構造要素**: リスト・引用・水平線の挿入

#### 統計情報
- **文字数カウント**: リアルタイム文字数表示
- **単語数カウント**: 単語数の自動計算
- **編集時間トラッキング**: 実際の編集時間測定

### 時間トラッキング機能

#### 編集時間測定
- **セッション単位**: 編集セッションごとの時間測定
- **累積時間**: メモ全体の編集時間集計
- **自動開始/停止**: 編集モード切り替えに連動

#### 表示機能
- **リアルタイム更新**: 編集中の秒単位更新
- **フォーマット表示**: HH:MM:SS形式での時間表示

### エクスポート・共有機能

#### ファイル出力（2025年8月2日実装）
- **テキスト共有**: プレーンテキストとしての共有
- **Markdown形式**: .md拡張子でのファイル出力
- **PDF形式**: .pdf拡張子での高品質ファイル出力
- **印刷機能**: システム印刷機能との連携
- **スマートネーミング**: メモタイトルを基にしたファイル名生成
- **システム連携**: iOS標準ShareSheetを活用した統合共有機能

#### PDFエクスポート機能（2025年7月31日実装）
- **高品質PDF生成**: A4サイズ（595x842ポイント）でのプロフェッショナル品質
- **HTML変換エンジン**: マークダウンからHTML経由でのPDF生成
- **詳細スタイリング**: CSS設定による美しいタイポグラフィ
- **テーブル対応**: Excel風のテーブルスタイリング
- **見出し番号付け**: H2-H6の自動番号付け機能
- **余白設定**: 30ポイントの適切な余白設定
- **ページ境界処理**: 自動的なページ境界の最適化

### 自動削除機能（2025年実装）
- **Apple純正風自動削除**: 新規メモで内容が空のまま終了した場合の自動削除
- **ユーザビリティ向上**: 不要なメモの自動清掃により、リストの整理状態を維持
- **スマート判定**: 真に空のメモのみを対象とした安全な削除処理

## ユーザーインターフェース

### メモ一覧画面（MemoListView）

#### 表示要素
- **メモリスト**: 作成日時順のメモ表示
- **ピン留めメモ**: 上位固定表示機能
- **検索バー**: リアルタイム検索機能
- **新規作成ボタン**: メモ追加機能
- **フォルダ切り替え**: サイドバーでのフォルダ選択

#### 表示情報
- **タイトル**: 自動生成またはカスタムタイトル
- **プレビュー**: 本文の抜粋表示
- **日時**: スマート日時表示（今日、昨日、今週など）
- **統計**: 文字数・編集時間表示
- **Markdownインジケーター**: コンテンツタイプの視覚的表示
- **ピン留めバッジ**: ピン留めメモの視覚的識別

#### 操作機能
- **タップして編集**: メモ選択で編集画面へ遷移
- **スワイプ削除**: メモの個別削除
- **ピン留め切り替え**: 重要メモの固定機能
- **検索ハイライト**: 検索語句の強調表示
- **フォルダ移動**: ドラッグ&ドロップによるメモ移動

### メモ編集画面（MemoEditorView）

#### 編集モード
- **テキストエディター**: カスタムハイライト対応エディター
- **Markdownツールバー**: クイック挿入機能
- **検索・置換**: 高度な検索置換機能
- **統計表示**: リアルタイム統計情報

#### プレビューモード
- **Markdownレンダリング**: リアルタイムプレビュー
- **読み取り専用**: 表示専用モード
- **共有機能**: テキスト、マークダウン、PDF出力対応
- **印刷機能**: システム印刷機能との統合
- **エクスポート**: 高品質PDF生成機能

#### ナビゲーション
- **モード切り替え**: 編集⇔プレビューの切り替え
- **自動モード**: 新規メモは編集、既存は プレビューで開始

### カスタムコンポーネント

#### HighlightableTextEditor
- **検索ハイライト**: 検索結果の視覚的強調
- **自動スクロール**: 現在の検索結果への自動移動
- **日本語対応**: 日本語コンテキストメニュー

## パフォーマンス最適化

### データ処理最適化
- **遅延保存**: タイピング中の過度なファイル操作防止
- **メモリ管理**: タイマーとリソースの適切な解放
- **遅延読み込み**: 効率的なリストレンダリング

### UI最適化
- **スムーズアニメーション**: モード切り替え時のトランジション
- **レスポンシブ検索**: デバウンス処理による効率的検索
- **適応的レイアウト**: 画面サイズに応じた表示調整

## ユーザーエクスペリエンス

### 言語対応
- **日本語UI**: 全インターフェースの日本語対応
- **適切なラベリング**: アクセシビリティ対応
- **文脈対応**: 操作に応じた適切なフィードバック

### 操作性
- **直感的ナビゲーション**: シンプルで分かりやすい画面遷移
- **コンテキスト対応**: モードに応じたボタン表示制御
- **効率的入力**: Markdownツールバーによる高速入力支援

### 状態管理
- **空状態対応**: メモなし・検索結果なしの適切な表示
- **エラーハンドリング**: 適切なエラー処理とユーザー通知
- **状態保持**: アプリ再起動時の状態復元

## システム要件

### 動作環境
- **iOS**: 最新版対応
- **ストレージ**: Documentsディレクトリへの書き込み権限
- **メモリ**: 効率的なメモリ使用量

### 依存関係
- **標準フレームワーク**: SwiftUI、Foundation、UIKit
- **外部ライブラリ**: なし（完全ネイティブ実装）

## アプリアイコン・ブランディング

### アプリアイコン設定（2025年実装）
- **プロフェッショナルアイコン**: App Store準拠の高品質アイコン
- **多サイズ対応**: iOS標準の全サイズバリエーション対応
- **ブランド統一**: メモアプリとしての視覚的アイデンティティ

## 拡張性

### アーキテクチャ設計
- **モジュラー設計**: 機能別の明確な分離
- **プロトコル指向**: 拡張可能な設計パターン
- **疎結合**: コンポーネント間の独立性
- **ハイブリッド構成**: SwiftUI + UIKit の最適な組み合わせ

### 将来的拡張可能性
- **WidgetKit対応**: ホーム画面ウィジェット機能の基盤準備済み
- **App Groups**: ウィジェットデータ共有の仕組み実装済み
- **URLスキーム**: `memoapp://new-memo`による外部連携対応
- **同期機能**: クラウド同期対応の基盤
- **プラグイン**: カスタム機能追加の仕組み
- **テーマ**: カスタマイズ可能な外観設定

## セキュリティ・プライバシー

### データ保護
- **ローカルストレージ**: 全データのローカル保存
- **暗号化対応**: iOSデフォルト暗号化利用
- **プライベート**: 外部送信なし

### 権限管理
- **最小権限**: 必要最小限のシステム権限
- **透明性**: 明確な権限用途説明

## 技術実装詳細

### MarkdownRenderer.swift（1062行、2025年7月31日実装）
- **HTML変換エンジン**: マークダウンからHTMLへの高品質変換
- **PDF生成エンジン**: HTMLからPDFへのプロフェッショナル変換
- **スタイリングシステム**: 詳細なCSSによる美しいタイポグラフィ
- **テーブル対応**: Excel風のテーブルスタイリング
- **見出し自動番号付け**: H2-H6の階層的番号管理

### ShareSheet.swift（51行、2025年7月31日実装）
- **カスタムアクティビティ**: マークダウン・PDF出力専用アクティビティ
- **UIActivity継承**: iOS標準共有機能との完全統合
- **FileDocument対応**: iOSファイルシステムとの連携

### 最新の技術統計
- **総コード行数**: 10,000行以上の本格的アプリケーション
- **最新コミット**: 358行追加、56行削除（302行の正味増加）
- **PDFコミット**: 2407行追加、30行削除（大規模機能追加）

---

**文書作成日**: 2025年7月13日  
**最終更新日**: 2025年8月2日  
**対象バージョン**: 1.2（共有機能・PDF対応版）  
**更新担当**: 開発チーム  
**最新機能**: テキスト・マークダウン・PDF共有、自動削除、アイコン設定